{"title":"Masters Fantasy Golf Tournament Dashboard","markdown":{"yaml":{"title":"Masters Fantasy Golf Tournament Dashboard","date":"2022-06-12","slug":[],"categories":["API","Cron","GoogleSheets","Web Scaping"],"tags":["API","Cron","GoogleSheets","Web Scaping"],"meta_img":"image/image.png","description":"Description for the page."},"headingText":"Collecting Leaderboard Data","containsRefs":false,"markdown":"\n\n```{r, setup, echo=FALSE}\nknitr::opts_chunk$set(echo = TRUE, \n                      warning = FALSE, \n                      message = FALSE)\n```\n\nThis blog posts shows how I use the `cronR` package to automate a fantasy golf pool with some friends for the golf major tournaments.\n\nThe process takes four steps:\n\n1.  Collect the leader board data\n2.  Prepare the data\n3.  Publish the data to GoogleSheets\n4.  Automate the script with cronR\n\nLets use the 2022 Masters tournament as an example of how we set up the pipeline.\n\n\nI've found success using two different methods here. Either through `rvest` to web scrape the leader board data off the web, i.e. [ESPN Leaderboard](https://www.espn.com/golf/leaderboard?tournamentId=401353232), or through an API. The API route takes more work, but I've found the ESPN Developer API to work well during the tournament. Here is the endpoint: `https://site.api.espn.com/apis/site/v2/sports/golf/pga/scoreboard`.\n\nFor this demo, we will use the web scraping approach, as there is no guarantee the API will work in the future.\n\n```{r, requirements}\n# packages \nlibrary(rvest)\nlibrary(googlesheets4) \nlibrary(cronR)\nlibrary(kableExtra) \nlibrary(dplyr)\nlibrary(tidyr)\n```\n\n```{r, webscrape}\nurl = \"https://www.espn.com/golf/leaderboard?tournamentId=401353232\"\n\ncontent = read_html(url)\nscores = content %>% \n  html_table() %>%\n  bind_rows() %>%\n  select(-1)\n\nscores %>%\n  kbl() %>%\n  kable_paper(\"striped\") %>%\n  scroll_box(height = \"500px\")\n```\n\nThe rules of our pool were to each pick 6 players. We would count the four lowest scores each day, and otherwise assign a score of +8 if you failed to have four players make the cut. The winner is the one with the lowest score for their team at the end of the tournament.\n\n### Join fantasy picks\n\nWe each fill out our teams by a snake draft often on Zoom. For the 2021 Masters, we filled our our results in a GoogleSheet. We can use the `googlesheets4` package to read in data from our GoogleSheet of picks into R.\n\n```{r}\nss = \"https://docs.google.com/spreadsheets/d/14nW_AWYil-jBQ2lC54k_lETGw_O031no-Q3FYvtwsUs/edit#gid=0\"\npicks = read_sheet(ss, sheet = \"draft\")\n\npicks %>%\n  pivot_wider(id_cols = Round, names_from = team, values_from = player) %>%\n  kbl() %>%\n  kable_paper(\"striped\")\n\n# join scoreboard data & reshape\nresults = picks %>%\n  select(-Round) %>%\n  left_join(scores %>% select(-c(\"POS\", \"SCORE\", \"TOT\", \"EARNINGS\", \"FEDEX PTS\") ), \n            by = c(\"player\" = \"PLAYER\")) %>%\n  pivot_longer(c(\"R1\", \"R2\", \"R3\", \"R4\"), names_to = \"round\", values_to = \"score\") %>%\n  mutate(score = ifelse(score == \"--\", 80, as.numeric(score))) # set MCs to 80\n\nresults %>%\n  kbl() %>%\n  kable_paper(\"striped\") %>%\n  scroll_box(height = \"500px\")\n```\n\n## Prepare Data & Compute Sidebets\n\nNow we have the scores read in, lets compute the day-by-day scores for each team. Recall, this is the four lowest scores per team per round.\n\n```{r}\npool_results = results %>%\n  group_by(team, round) %>%\n  arrange(team, round, score) %>%\n  mutate(count_score = ifelse(rank(score, ties.method = \"first\") <= 4, 1, 0)) %>%\n  summarise(value = sum(score * count_score) - 72 * 4) %>%\n  ungroup()\n\ntotal_scores = pool_results %>% \n  pivot_wider(id_cols = team, names_from = round, values_from = value) %>%\n  group_by(team) %>%\n  mutate(Total = sum(across())) %>%\n  arrange(Total)\n\ntotal_scores %>%\n  kbl() %>%\n  kable_paper(\"striped\")\n\nplayer_scores = results %>%\n  pivot_wider(id_cols = c(\"player\", \"team\"), names_from = round, values_from = score)\n\nplayer_scores %>%\n  select(-team) %>%\n  kbl(col.names = c(\"Team\", \"Round 1\", \"Round 2\", \"Round 3\", \"Round 4\")) %>%\n  pack_rows(index = table(player_scores$team)) %>%\n  kable_paper() %>%\n  scroll_box(height = \"500px\")\n\n\n```\n\n## Write to GoogleSheets\n\nLets write our total table to a GoogleSheet where everyone in the competition can view. [The googlesheet can be viewed here.](https://docs.google.com/spreadsheets/d/14nW_AWYil-jBQ2lC54k_lETGw_O031no-Q3FYvtwsUs/edit#gid=1784722044)\n\n```{r}\n# add data to sheet\nplayer_scores %>%\n  select(team, player, R1, R2, R3, R4) %>%\n  write_sheet(ss, sheet = \"leaderboard\")\n\n# add a total leader board table\nss %>%\n  range_write(total_scores, sheet = \"leaderboard\", range = \"H1\")\n\n# add date last updated \nss %>%\n  range_write(data = data.frame(Last_updated = as.character(Sys.time())),\n              sheet = \"leaderboard\",\n              range = \"O2\")\n\n```\n\nFrom here, we can build plots off of the data ranges in our GoogleSheet, and update the formatting however we would like.\n\n## Automate with cronR\n\n`cronR` is a unix/linux tool that allows us to schedule R scripts. We are able to set jobs that will run on specific intervals. For example, we can have our leader board update every 15 minutes during the tournament to provide live updates.\n\n### Setting the cron job\n\nWe use `cron_add()` to set the cron job. I found when using MacOS that I had to allow cron permissions in system preferences. I found [this tutorial](https://osxdaily.com/2020/04/27/fix-cron-permissions-macos-full-disk-access/) to be helpful.\n\nOnce you install the package, you can also use the RStudio addin, found at `Addins > Schedule R scripts on Linux/Unix`.\n\n```{r, eval=FALSE, echo=T}\nwd = getwd()\nscript = file.path(wd, \"index.rmd\")\ncmd = cron_rscript(script, \n                   log_append = TRUE, \n                   log_timestamp = TRUE)\ncron_add(command = cmd, \n         frequency = \"*/15 * * * *\", \n         id = \"2021-masters-pool\", \n         description = \"update masters pool every 15 mintues\")\n\n```\n\n### Viewing and Removing cron jobs\n\nThis is as simple as using `cron_ls()` to list the cron jobs, and `cron_rm()` to remove jobs by their id.\n\n```{r, eval=FALSE, echo=T}\ncron_ls()\n\ncron_rm(\"2021-masters-pool\")\n\n```\n\n## Other Comments\n\nWhile we web scraped the leader board data, I find the API can allow you to get richer data. Specifically hole-by-hole scores. This data allows for other side bets. Specifically having skins or a horse race. The downside is the API changes based on the status of the current event, therefore often requires daily checking.\n\nAdditionally, you can pull the individual scorecard data from the ESPN player pages. For example, see [Rory McIlroy here](https://www.espn.com/golf/player/_/id/3470/rory-mcilroy).\n\nGoogleSheets also have a `read_html()` function, which allow you to read the raw data straight into the GoogleSheet. This can remove needing to use R, however you lose the flexibility of being able to update the sheet at whatever period you wish, and you are limited if you wish to do more complex analysis.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.313","theme":{"light":["sandstone","../../_light.scss"],"dark":["sandstone","../../_dark.scss"]},"editor":"source","title":"Masters Fantasy Golf Tournament Dashboard","date":"2022-06-12","slug":[],"categories":["API","Cron","GoogleSheets","Web Scaping"],"tags":["API","Cron","GoogleSheets","Web Scaping"],"meta_img":"image/image.png","description":"Description for the page."},"extensions":{"book":{"multiFile":true}}}}}